<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Massimo raggiunto</title>
  <script type="module">
    import { getApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";
    import { database, goOffline, goOnline } from './firebase.js';

    const app = getApp();
    const db = getDatabase(app);

    let inactivityTimer;
    let isConnected = true;

    function disconnectAfterInactivity() {
      if (isConnected) {
        goOffline(database);
        isConnected = false;
      }
    }

    function reconnectOnActivity() {
      if (!isConnected) {
        goOnline(database);
        isConnected = true;
      }
    }

    function resetInactivityTimer() {
      reconnectOnActivity();
      clearTimeout(inactivityTimer);
      inactivityTimer = setTimeout(disconnectAfterInactivity, 60 * 1000);
    }

    window.addEventListener("mousemove", resetInactivityTimer);
    window.addEventListener("mousedown", resetInactivityTimer);
    window.addEventListener("keypress", resetInactivityTimer);
    window.addEventListener("touchmove", resetInactivityTimer);
    resetInactivityTimer();

    const configRef = ref(db, "config");
    const reservationsRef = ref(db, "reservations");

    let maxPrenotazioni = 25;
    let previousMax = null;
    let currentReservations = [];
    let initialLoad = true;

    function checkAndRedirect(reservations) {
      const container = document.getElementById("maxReached");
      const numPrenotazioni = Array.isArray(reservations)
        ? reservations.filter(Boolean).length
        : Object.keys(reservations).length;

      const postiLiberi = numPrenotazioni < maxPrenotazioni;

      if (postiLiberi && maxPrenotazioni > previousMax) {
        if (!document.getElementById("redirectMsg")) {
          const msg = document.createElement("p");
          msg.id = "redirectMsg";
          msg.innerHTML = "<em><strong>Sono stati messi a disposizione altri posti! Reindirizzamento...</strong></em>";
          container.appendChild(msg);
        }
        setTimeout(() => window.location.href = "index.html", 3000);
        previousMax = maxPrenotazioni;
      }
      else if (!initialLoad && postiLiberi && maxPrenotazioni === previousMax) {
        if (!document.getElementById("manualReturnMsg")) {
          const msg = document.createElement("p");
          msg.id = "manualReturnMsg";
          msg.innerHTML = "<em><strong>✨ Un posto si è liberato! Reindirizzamento...</strong></em>";
          container.appendChild(msg);
          setTimeout(() => window.location.href = "index.html", 3000);
        }
      }
    }

    onValue(configRef, (snapshot) => {
      const config = snapshot.val();
      if (previousMax === null) previousMax = config.maxPrenotazioni || 25;
      maxPrenotazioni = config.maxPrenotazioni || 25;
      checkAndRedirect(currentReservations);
    });

    onValue(reservationsRef, (snapshot) => {
      currentReservations = snapshot.val() || [];
      checkAndRedirect(currentReservations);
      initialLoad = false;
    });
  </script>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header>
    <div class="centerLogo">
      <a href="home.html"><img src="img/scrittalogo.PNG" alt="logo I Ragazzi"></a>
    </div>  
    <a href="editor.html" id="cogEditor" class="editor-btn">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
        <path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c...Z" />
        <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
      </svg>
    </a>
  </header>
  <div class="maxCenter">
    <main id="mainMax">
      <section id="maxReached" class="visible">
        <h2>Numero massimo di prenotazioni raggiunto!</h2>
        <p>Non sei stato abbastanza veloce?<br />
        Seguici su Instagram per le prossime date.</p>
        <a class="insta-link" href="https://www.instagram.com/iragazzi_band" target="_blank">@iragazzi_band</a>
      </section>
    </main>
  </div>
</body>
</html>